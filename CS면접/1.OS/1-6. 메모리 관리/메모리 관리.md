# 메모리 관리

- 메모리: 메인 메모리, RAM을 뜻함. 프로그램 실행 시 필요한 주소, 정보들을 저장하고 가져다 사용할 수 있게 만드는 공간



## 메모리 관리는?

- 중앙 처리 장치, 메모리, 스토리지 ,주변 기기 등을 적절히 관리하는 기법
- CPU가 프로그램을 읽어서 연속적으로 동작하기 위해서는 메모리 관리가 중요



## 메모리 관리 기본 사항

##### 가상메모리 (Virtual Memory)

- 각 프로그램에 실제 메모리 주소가 아닌 가상의 메모리 주소를 부여하는 방식
- 가상 주소, 물리주소가 있고 가상 주소의 범위를 가상 주소 공간, 물리 주소의 범위를 물리 주소 공간이라 함
- 가상 주소 공간은 메모리 관리 장치(MMU)에 의해 물리 주소로 변환

##### 메모리 관리 장치 (MMU)

- CPU가 메모리에 접근하는 것을 관리하는 컴퓨터 하드웨어 부품
- 가상 메모리 주소를 실제 메모리 주소로 변환
- 메모리 보호, 캐시 관리, 버스 중재 등의 역할을 담당

##### 메모리 관리자

- 기억 장치의 어느 부분이 사용 중인지 아닌지를 조사하여 프로세스에게 필요할 때마다 기억 장치를 할당 후 회수하는 작업 수행
- 실행 파일 심볼의 재배치 주소를 프로세스 의 논리 주소로 연결시키는 작업 수행



## 메모리 관리 기법

- 운영체제의 역할에서 메모리 관리가 큰 역할을 차지하는 이유는 메모리가 고가의 자원이고, 시스템에서 중요한 역할을 수행하기 때문
- 반입 기법, 배치 기법, 할당 기법, 교체 기법

#### 반입 기법

- 주기억장치에 적재할 다음 프로세스의 반입시기를 결정하는 기법
- 메모리로 적재 시기 결정 

|      기법      |                             설명                             |
| :------------: | :----------------------------------------------------------: |
| 요구 반입 기법 | 다음에 실행될 프로세스가 참조 요구가 있을 경우에 적재하는 기법 |
| 예상 반입 기법 | 시스템의 요구를 예측하여 미리 메모리에 적재하는 방법으로 요구되는 페이지 이외 다른 페이지도 함께 적재 |

#### 배치 기법

- 디스크에 있는 프로세스를 주기억장치의 어느 위치에 저장할 것인지 결정하는 기법
- 메모리 적재 위치 결정

|         기법          |                             설명                             |
| :-------------------: | :----------------------------------------------------------: |
| 최초 적합 (First Fit) | 프로세스가 적재될 수 있는 가용 공간 중에서 첫 번째 분할에 할당하는 방식 |
| 최적 적합 (Best Fit)  | 가용 공간 중에서 가장 크기가 비슷한 공간을 선택하여 프로세스를 적재하는 방식 ( 공백 최소화 장점) |
| 최악 적합 (Worst-Fit) |   프로세스의 가용 공간 중에서 가장 큰 공간에 할당하는 방식   |

##### 최초 적합

<img src="메모리 관리.assets/image-20220507171238415.png" alt="image-20220507171238415" style="zoom:80%;" />

##### 최적 적합

<img src="메모리 관리.assets/image-20220507171326498.png" alt="image-20220507171326498" style="zoom:80%;" />

##### 최악 적합

<img src="메모리 관리.assets/image-20220507171352392.png" alt="image-20220507171352392" style="zoom:80%;" />

#### 메모리 할당 기법

- 실행해야할 프로세스를 주기억장치에 어떤 방법으로 할당할 것인지 결정하는 기법
- 메모리 적재 방법 결정

|      종류      |                             설명                             |                             기법                             |
| :------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
| 연속 할당 기법 | 실행을 위한 각 프로세스를 주기억장치 공간내에서 인접되게 연속하여 저장하는 방법 | 단일 분할 할당 기법( 오버레이, 스와핑), 다중 분할 할당 기법(고정 분할 할당 기법, 동적 분할 할당 기법) |
| 분산 할당 기법 | 하나의 프로세스를 여러 개의 조각으로 나누어 주기억장치 공간 내 분산하여 배치하는 기법 |   페이징 기법, 세그먼테이션 기법, 페이징/세그먼테이션 기법   |

##### 페이징 기법

- 페이징 기법은 가상기억장치 내의 프로세스를 일정하게 분할하여 주기억장치의 분산된 공간에 적재시킨 후 프로세스를 수행시키는 기법
- 실제 공간은 페이지 크기와 같은 페이지 프레임으로 나누어 사용
- 논리 주소는 페이지 번호와 변위로 구성되어 있다.
- 페이지 테이블에서 실제 메모리 기준 주소를 찾고 변위를 더해 물리 메모리 주소를 결정
- 장점 : 공유 페이지 이용, 메모리 활용을 통한 다중 처리 프로그래밍 가능
- 단점 : 페이징 사상 하드웨어 비용 소요, 속도 저하, 내부 단편화 현상 발생
- 페이지 크기가 작을 경우 발생 현상
  - 더 많은 페이지 사상 테이블 공간이 필요
  - 내부 단편화는 불고, 특정한 참조 구역성만을 포함하기 때문에 기억 장치 효율이 좋음
  - 페이지 정보를 갖는 페이지 맵 테이블의 크기가 커지고, 매핑 속도가 늦어짐
  - 디스크 접근 횟수가 많아져서 전체적인 입출력 시간 증가
- 페이지 크기가 클 경우 발생 현상
  - 테이블의 크기가 작아지므로 주기억 장치의 공간이 절약
  - 페이지 정보를 갖는 페이지 맵 테이블의 크기가 작아져서 관리가 용이하고, 매핑 속도가 빨라짐
  - 디스크 접근 횟수가 줄고, 전체적인 입출력 시간 감소
  - 페이지 단편화가 증가하고 이에 따라 기억 공간의 낭비 초래

##### 세그먼테이션 기법

- 가상기억장치 내의 프로세스를 가변적인 크기의 블록으로 나누고 메모리를 할당하는 기법
- 분할 형태가 배열이나 함수와 같은 논리적인 다양한 크기의 가변적인 크기로 관리한다.
- 논리 주소는 세그먼트 번호와 변위로 구성됨
- 세그먼트 테이블은 기준과 한계로 메모리의 시작 주소와 길이 확인
- 세그먼트 테이블은 메인 메모리에 존재
- 장점: 가변적인 데이터 구조와 모듈 처리, 자원의 효율적 이용
- 단점: 외부 단편화 현상 발생

##### 페이징/세그먼테이션 혼용기법

- 외부 단편화 및 내부 단편화 최소화를 위해 세그먼테이션 기법과 페이징 기법을 결합한 페이징/세그먼테이션 기법이 개발됨
- 하나의 세그먼트를 정수 배의 부분 페이지로 다시 분할하는 방식
- 세그먼트가 너무 가변적인 길이이고 크기가 너무 클 때가 있어서 주기억장치에 적재할 수 없는 문제점을 해결

#### 교체 기법

- 주기억장치에 있는 프로세스 중 어떤 프로세스를 제거할 것인지 결정하는 기법
- 새로운 페이지를 할당하기 위해 현재 할당된 페이지 중 어느 것과 교체할지 결정하는 방법



|           세부 기법            |                             설명                             |
| :----------------------------: | :----------------------------------------------------------: |
|   FIFO ( First In First Out)   | 각 페이지가 주기억장치에 적재될 때마다 그 시간을 기억시켜 가장 먼저 들어와서 오래있던 페이지를 교체하는 기법 |
|    LRU(Least Recently Used)    | 사용된 시간을 확인하여 가장 오랫동안 사용되지 않은 페이지를 선택하여 교체하는 기법 |
|   LFU(Least Frequently Used)   | 사용된 횟수를 확인하여 참조 횟수가 가장 적은 페이지를 선택하여 교체하는 기법 |
|    OPT(OPTimal Replacement)    |  앞으로 가장 오랫동안 사용하지 않을 페이지를 교체하는 기법   |
|     NUR(Not Used Recently)     | LRU와 비슷한 알고리즘으로 최근에 사용하지 않은 페이지를 교체하는 기법 |
| SCR(Second Chance Replacement) | 가장 오랫동안 주기억장치에 있던 페이지 중 자주 사용되는 페이지의 교체를 방지하기 위한 기법으로 FIFO기법의 단점을 보완하는 기법 |



## 메모리 단편화

분할된 주기억장치에 프로세스를 할당, 반납 과정에서 사용되지 못하고 낭비되는 기억장치가 발생하는 현상

#### 내부 단편화

- 분할된 공간에 프로세스를 적재한 후 남은 공간
- 고정 분할 할당 방식 또는 페이징 기법 사용시 발생하는 메모리 단편화
- 해결 방안 : Slab Allocator, 통합 압축

#### 외부 단편화

- 할당된 크기가 프로세스 크기보다 작아서 사용하지 못하는 공간
- 가변 분할 할당 방식 또는 세그먼테이션 기법 사용 시 발생하는 메모리 단편화
- 해결 방안: 버디 메모리 할당, 통합, 압축



## 페이징 기법의 문제 및 해결 방안

#### 문제점 - 스레싱(Thrashing)

- 스레싱은 어떤 프로세가 계속적으로 페이지 부재가 발생하여 프로세스의 실제처리 시간보다 페이지 교체 시간이 더 많아지는 현상
- 오류율이 클수록 스레싱이 많이 발생한 것이고 스레싱으로 인해 전체 시스템 성능 및 처리율 저하됨
- 페이지 부재가 계속 증가하여 기억장치 접근 시간이 증가

#### 해결방안

##### 워킹세트(working set)

- 각 프로세스가 많이 참조하는 페이지들의 집합을 주기억장치 공간에 계속 상주하게 하여 빈번한 페이지 교체현상을 줄이고자 하는 기법
- 장점: 멀티프로그래밍 정도를 높일 수 있고 CPU 활용률을 최적화할 수 있음
- 단점: 워킹 세트 추적관리가 복잡하고 워킹세트 크기 설정의 모호함이 발생

##### 페이지 부재 빈도(PFF: Page_Fault Frequency)

- 페이지 부재율의 상한과 하한을 정해서 직접적으로 페이지 부재율을 예측하고 조절하는 기법
- 페이지 부재 비율에 따라 페이지 프레임 개수 조절
- 장점: 페이지 부재 발생 시실행하여 부하가 적과, 직접적으로 페이지 부재율 조절이 가능함
- 단점: 프로세스를 중지시키는 과정이 발생하고, 페이지 참조가 새로운 지역성으로 이용할 수 있음



## 지역성

-  지역성(국부성, 구역성, 국소성)은 프로세스가 실행되는 동안 주기억장치를 참조할 때 일부 페이지만 집중적으로 참조하는 특성
- 스레싱 방지하기 위한 워킹 셋 이론의 기반
- 참조 지역성이라고도 불리며 3가지 유형 존재

|    유형     |                             설명                             |
| :---------: | :----------------------------------------------------------: |
| 시간 지역성 | 최근 사용되었던 기억장소들이 집증적으로 액세스하는 현상, 참조했던 메모리는 빠른 시간에 다시 참조될 확률이 높은 특성 |
| 공간 지역성 | 프로세스 실행 시 일정 위치의 페이지를 집중적으로 액세스하는 현상, 참조된 메모리 근처의 메모리를 참조하는 특성 |
| 순차 지역성 | 데이터가 순차적으로 액세스되는 현상, 프로그램 내의 명령어가 순차적으로 구성된 특성, 공간 지역성에 편입되어 설명되기도 함 |

